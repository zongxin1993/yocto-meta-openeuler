--- iSulad-v2.0.17/src/client/connect/protocol_type.h   2022-09-19 09:11:13.599835541 +0800
+++ iSulad-v2.0.17/src/client/connect/protocol_type.h   2022-09-19 09:14:51.844509875 +0800
@@ -54,11 +54,11 @@ struct isula_create_response {

 struct isula_start_request {
     char *name;
-    char *stdin;
+    char *stdin1;
     bool attach_stdin;
-    char *stdout;
+    char *stdout1;
     bool attach_stdout;
-    char *stderr;
+    char *stderr1;
     bool attach_stderr;
 };

@@ -323,9 +323,9 @@ struct isula_exec_request {
     bool attach_stdin;
     bool attach_stdout;
     bool attach_stderr;
-    char *stdin;
-    char *stdout;
-    char *stderr;
+    char *stdin1;
+    char *stdout1;
+    char *stderr1;
     int argc;
     char **argv;
     size_t env_len;
@@ -344,9 +344,9 @@ struct isula_exec_response {

 struct isula_attach_request {
     char *name;
-    char *stdin;
-    char *stdout;
-    char *stderr;
+    char *stdin1;
+    char *stdout1;
+    char *stderr1;
     bool attach_stdin;
     bool attach_stdout;
     bool attach_stderr;

--- iSulad-v2.0.17/src/client/connect/protocol_type.c   2022-09-19 09:21:57.492775372 +0800
+++ iSulad-v2.0.17/src/client/connect/protocol_type.c   2022-09-19 09:23:54.711674661 +0800
@@ -280,14 +280,14 @@ void isula_start_request_free(struct isu
     free(request->name);
     request->name = NULL;

-    free(request->stdin);
-    request->stdin = NULL;
+    free(request->stdin1);
+    request->stdin1 = NULL;

-    free(request->stdout);
-    request->stdout = NULL;
+    free(request->stdout1);
+    request->stdout1 = NULL;

-    free(request->stderr);
-    request->stderr = NULL;
+    free(request->stderr1);
+    request->stderr1 = NULL;

     free(request);
 }
@@ -513,14 +513,14 @@ void isula_exec_request_free(struct isul
     free(request->suffix);
     request->suffix = NULL;

-    free(request->stdout);
-    request->stdout = NULL;
+    free(request->stdout1);
+    request->stdout1 = NULL;

-    free(request->stdin);
-    request->stdin = NULL;
+    free(request->stdin1);
+    request->stdin1 = NULL;

-    free(request->stderr);
-    request->stderr = NULL;
+    free(request->stderr1);
+    request->stderr1 = NULL;

     free(request->user);
     request->user = NULL;
@@ -562,14 +562,14 @@ void isula_attach_request_free(struct is
     free(request->name);
     request->name = NULL;

-    free(request->stderr);
-    request->stderr = NULL;
+    free(request->stderr1);
+    request->stderr1 = NULL;

-    free(request->stdout);
-    request->stdout = NULL;
+    free(request->stdout1);
+    request->stdout1 = NULL;

-    free(request->stdin);
-    request->stdin = NULL;
+    free(request->stdin1);
+    request->stdin1 = NULL;

     free(request);
 }

--- iSulad-v2.0.17/src/client/connect/rest/rest_containers_client.c     2022-09-19 09:27:58.672546293 +0800
+++ iSulad-v2.0.17/src/client/connect/rest/rest_containers_client.c     2022-09-19 09:38:59.355614190 +0800
@@ -87,14 +87,14 @@ static int start_request_to_rest(const s
     if (ls_request->name != NULL) {
         crequest->id = util_strdup_s(ls_request->name);
     }
-    if (ls_request->stdout != NULL) {
-        crequest->stdout = util_strdup_s(ls_request->stdout);
+    if (ls_request->stdout1 != NULL) {
+        crequest->stdout1 = util_strdup_s(ls_request->stdout1);
     }
-    if (ls_request->stdin != NULL) {
-        crequest->stdin = util_strdup_s(ls_request->stdin);
+    if (ls_request->stdin1 != NULL) {
+        crequest->stdin1 = util_strdup_s(ls_request->stdin1);
     }
-    if (ls_request->stderr != NULL) {
-        crequest->stderr = util_strdup_s(ls_request->stderr);
+    if (ls_request->stderr1 != NULL) {
+        crequest->stderr1 = util_strdup_s(ls_request->stderr1);
     }
     crequest->attach_stdin = ls_request->attach_stdin;
     crequest->attach_stdout = ls_request->attach_stdout;
@@ -207,14 +207,14 @@ static int attach_request_to_rest(const
     if (la_request->name != NULL) {
         crequest->container_id = util_strdup_s(la_request->name);
     }
-    if (la_request->stdout != NULL) {
-        crequest->stdout = util_strdup_s(la_request->stdout);
+    if (la_request->stdout1 != NULL) {
+        crequest->stdout1 = util_strdup_s(la_request->stdout1);
     }
-    if (la_request->stdin != NULL) {
-        crequest->stdin = util_strdup_s(la_request->stdin);
+    if (la_request->stdin1 != NULL) {
+        crequest->stdin1 = util_strdup_s(la_request->stdin1);
     }
-    if (la_request->stderr != NULL) {
-        crequest->stderr = util_strdup_s(la_request->stderr);
+    if (la_request->stderr1 != NULL) {
+        crequest->stderr1 = util_strdup_s(la_request->stderr1);
     }
     crequest->attach_stdin = la_request->attach_stdin;
     crequest->attach_stdout = la_request->attach_stdout;
@@ -1611,14 +1611,14 @@ static int exec_request_to_rest(const st
     if (le_request->name != NULL) {
         crequest->container_id = util_strdup_s(le_request->name);
     }
-    if (le_request->stdout != NULL) {
-        crequest->stdout = util_strdup_s(le_request->stdout);
+    if (le_request->stdout1 != NULL) {
+        crequest->stdout1 = util_strdup_s(le_request->stdout1);
     }
-    if (le_request->stdin != NULL) {
-        crequest->stdin = util_strdup_s(le_request->stdin);
+    if (le_request->stdin1 != NULL) {
+        crequest->stdin1 = util_strdup_s(le_request->stdin1);
     }
-    if (le_request->stderr != NULL) {
-        crequest->stderr = util_strdup_s(le_request->stderr);
+    if (le_request->stderr1 != NULL) {
+        crequest->stderr1 = util_strdup_s(le_request->stderr1);
     }
     if (le_request->suffix != NULL) {
         crequest->suffix = util_strdup_s(le_request->suffix);

--- iSulad-v2.0.17/src/daemon/modules/runtime/engines/lcr/lcr_rt_ops.c  2022-09-19 09:43:42.136783044 +0800
+++ iSulad-v2.0.17/src/daemon/modules/runtime/engines/lcr/lcr_rt_ops.c  2022-09-19 09:42:58.598449116 +0800
@@ -487,8 +487,8 @@ int rt_lcr_attach(const char *name, cons
         goto out;
     }

-    if (!engine_ops->engine_console_op(name, params->rootpath, (char *)params->stdin, (char *)params->stdout,
-                                       (char *)params->stderr)) {
+    if (!engine_ops->engine_console_op(name, params->rootpath, (char *)params->stdin1, (char *)params->stdout1,
+                                       (char *)params->stderr1)) {
         ERROR("attach failed");
         const char *tmpmsg = NULL;
         if (engine_ops->engine_get_errmsg_op != NULL) {

--- iSulad-v2.0.17/src/daemon/modules/runtime/isula/isula_rt_ops.c      2022-09-19 09:46:39.902146450 +0800
+++ iSulad-v2.0.17/src/daemon/modules/runtime/isula/isula_rt_ops.c      2022-09-19 09:47:47.711666534 +0800
@@ -834,9 +834,9 @@ int rt_isula_create(const char *id, cons
     p.exit_fifo = (char *)params->exit_fifo;
     p.open_tty = params->tty;
     p.open_stdin = params->open_stdin;
-    p.isulad_stdin = (char *)params->stdin;
-    p.isulad_stdout = (char *)params->stdout;
-    p.isulad_stderr = (char *)params->stderr;
+    p.isulad_stdin = (char *)params->stdin1;
+    p.isulad_stdout = (char *)params->stdout1;
+    p.isulad_stderr = (char *)params->stderr1;
     p.runtime_args = (char **)runtime_args;
     p.runtime_args_len = runtime_args_len;
     copy_process(&p, config->process);
@@ -1343,4 +1343,4 @@ int rt_isula_kill(const char *id, const
     }

     return 0;
-}
\ No newline at end of file
+}

--- iSulad-v2.0.17/src/daemon/executor/container_cb/execution.c 2022-09-19 09:49:53.940634672 +0800
+++ iSulad-v2.0.17/src/daemon/executor/container_cb/execution.c 2022-09-19 09:50:50.743070321 +0800
@@ -270,7 +270,7 @@ static int prepare_start_io(container_t
             goto out;
         }

-        if (ready_copy_io_data(*sync_fd, false, request->stdin, request->stdout, request->stderr, stdinfd,
+        if (ready_copy_io_data(*sync_fd, false, request->stdin1, request->stdout1, request->stderr1, stdinfd,
                                stdout_handler, stderr_handler, (const char **)fifos, thread_id)) {
             ret = -1;
             goto out;

--- iSulad-v2.0.17/src/daemon/executor/container_cb/execution_stream.c  2022-09-19 09:52:35.190871412 +0800
+++ iSulad-v2.0.17/src/daemon/executor/container_cb/execution_stream.c  2022-09-19 09:54:16.304646931 +0800
@@ -266,7 +266,7 @@ static int attach_prepare_console(const
             goto out;
         }

-        if (ready_copy_io_data(*sync_fd, false, request->stdin, request->stdout, request->stderr, stdinfd,
+        if (ready_copy_io_data(*sync_fd, false, request->stdin1, request->stdout1, request->stderr1, stdinfd,
                                stdout_handler, stderr_handler, (const char **)fifos, tid)) {
             ret = -1;
             goto out;
@@ -342,9 +342,9 @@ static int container_attach_cb(const con
     }

     params.rootpath = cont->root_path;
-    params.stdin = fifos[0];
-    params.stdout = fifos[1];
-    params.stderr = fifos[2];
+    params.stdin1 = fifos[0];
+    params.stdout1 = fifos[1];
+    params.stderr1 = fifos[2];

     (void)isulad_monitor_send_container_event(id, ATTACH, -1, 0, NULL, NULL);

--- iSulad-v2.0.17/src/daemon/modules/api/runtime_api.h 2022-09-19 10:21:19.315094981 +0800
+++ iSulad-v2.0.17/src/daemon/modules/api/runtime_api.h 2022-09-19 10:23:19.310015312 +0800
@@ -70,9 +70,9 @@ typedef struct _rt_create_params_t {
     const char *state;
     void *oci_config_data;
     bool terminal;
-    const char *stdin;
-    const char *stdout;
-    const char *stderr;
+    const char *stdin1;
+    const char *stdout1;
+    const char *stderr1;
     const char *exit_fifo;
     bool tty;
     bool open_stdin;
@@ -156,9 +156,9 @@ typedef struct _rt_resume_params_t {

 typedef struct _rt_attach_params_t {
     const char *rootpath;
-    const char *stdin;
-    const char *stdout;
-    const char *stderr;
+    const char *stdin1;
+    const char *stdout1;
+    const char *stderr1;
 } rt_attach_params_t;

 typedef struct _rt_update_params_t {

--- iSulad-v2.0.17/src/daemon/modules/service/service_container.c       2022-09-19 10:45:35.318254990 +0800
+++ iSulad-v2.0.17/src/daemon/modules/service/service_container.c       2022-09-19 10:47:35.547173581 +0800
@@ -825,9 +825,9 @@ static int do_start_container(container_
     create_params.state = cont->state_path;
     create_params.oci_config_data = oci_spec;
     create_params.terminal = tty;
-    create_params.stdin = console_fifos[0];
-    create_params.stdout = console_fifos[1];
-    create_params.stderr = console_fifos[2];
+    create_params.stdin1 = console_fifos[0];
+    create_params.stdout1 = console_fifos[1];
+    create_params.stderr1 = console_fifos[2];
     create_params.exit_fifo = exit_fifo;
     create_params.tty = tty;
     create_params.open_stdin = open_stdin;
@@ -1886,7 +1886,7 @@ static int exec_prepare_console(const co
             ret = -1;
             goto out;
         }
-        if (ready_copy_io_data(*sync_fd, false, request->stdin, request->stdout, request->stderr, stdinfd,
+        if (ready_copy_io_data(*sync_fd, false, request->stdin1, request->stdout1, request->stderr1, stdinfd,
                                stdout_handler, stderr_handler, (const char **)fifos, thread_id)) {
             ret = -1;
             goto out;

--- iSulad-v2.0.17/src/cmd/isula/base/start.c   2022-09-19 11:16:14.838156121 +0800
+++ iSulad-v2.0.17/src/cmd/isula/base/start.c   2022-09-19 11:18:12.374049157 +0800
@@ -124,9 +124,9 @@ static int do_client_start(const struct

     request.name = args->name;
     if (console_fifos != NULL && *console_fifos != NULL) {
-        request.stdin = (*console_fifos)->stdin_name;
-        request.stdout = (*console_fifos)->stdout_name;
-        request.stderr = (*console_fifos)->stderr_name;
+        request.stdin1 = (*console_fifos)->stdin_name;
+        request.stdout1 = (*console_fifos)->stdout_name;
+        request.stderr1 = (*console_fifos)->stderr_name;
     }
     request.attach_stdin = args->custom_conf.attach_stdin;
     request.attach_stdout = args->custom_conf.attach_stdout;

--- iSulad-v2.0.17/src/cmd/isula/stream/exec.c  2022-09-19 11:22:01.760792010 +0800
+++ iSulad-v2.0.17/src/cmd/isula/stream/exec.c  2022-09-19 11:22:29.969006333 +0800
@@ -60,9 +60,9 @@ static int fill_exec_request(const struc
     request->attach_stdout = args->custom_conf.attach_stdout;
     request->attach_stderr = args->custom_conf.attach_stderr;
     if (fifos != NULL) {
-        request->stdin = util_strdup_s(fifos->stdin_name);
-        request->stdout = util_strdup_s(fifos->stdout_name);
-        request->stderr = util_strdup_s(fifos->stderr_name);
+        request->stdin1 = util_strdup_s(fifos->stdin_name);
+        request->stdout1 = util_strdup_s(fifos->stdout_name);
+        request->stderr1 = util_strdup_s(fifos->stderr_name);
     }

     request->user = util_strdup_s(args->custom_conf.user);

--- iSulad-v2.0.17/src/cmd/isula/stream/attach.c        2022-09-19 11:23:59.246684654 +0800
+++ iSulad-v2.0.17/src/cmd/isula/stream/attach.c        2022-09-19 11:24:48.674060200 +0800
@@ -398,9 +398,9 @@ static int client_attach(struct client_a
         ret = ECOMMON;
         goto out;
     }
-    request.stdin = util_strdup_s(attach_fifos->stdin_name);
-    request.stdout = util_strdup_s(attach_fifos->stdout_name);
-    request.stderr = util_strdup_s(attach_fifos->stderr_name);
+    request.stdin1 = util_strdup_s(attach_fifos->stdin_name);
+    request.stdout1 = util_strdup_s(attach_fifos->stdout_name);
+    request.stderr1 = util_strdup_s(attach_fifos->stderr_name);
 #endif

     config = get_connect_config(args);

--- iSulad-v2.0.17/src/CMakeLists.txt   2022-09-19 14:44:22.526007835 +0800
+++ iSulad-v2.0.17/src/CMakeLists.txt   2022-09-19 14:43:07.452410938 +0800
@@ -49,6 +49,7 @@ target_include_directories(libisulad_too
 )
 set_target_properties(libisulad_tools PROPERTIES PREFIX "")
 target_link_libraries(libisulad_tools ${ZLIB_LIBRARY} ${ISULA_LIBUTILS_LIBRARY} ${CRYPTO_LIBRARY})
+target_link_libraries(libisulad_tools -lexecinfo -lmallocutils)

 if (ENABLE_OCI_IMAGE)
     target_link_libraries(libisulad_tools ${LIBARCHIVE_LIBRARY})

--- iSulad-v2.0.17/src/daemon/modules/image/image_rootfs_handler.c      2022-09-26 09:24:19.359973622 +0800
+++ iSulad-v2.0.17/src/daemon/modules/image/image_rootfs_handler.c      2022-09-26 09:44:38.957115144 +0800
@@ -26,6 +26,8 @@
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
+#include <pthread.h>
+#include <assert.h>

 #include "isula_libutils/log.h"
 #include "err_msg.h"
@@ -42,6 +44,147 @@
 #define UnixPasswdPath "/etc/passwd"
 #define UnixGroupPath "/etc/group"

+static pthread_mutex_t pwent_mutex = PTHREAD_MUTEX_INITIALIZER;
+static int __fgetpwent_r(FILE *stream, struct passwd *pwd, char *buf,
+                         size_t len, struct passwd **result)
+{
+        struct passwd *pwtmp;
+        char *cursor = buf, *end = buf + len;
+
+        *result = NULL;
+        pthread_mutex_lock(&pwent_mutex);
+        pwtmp = stream != NULL ? fgetpwent(stream) : getpwent();
+        if (pwtmp == NULL) {
+                pthread_mutex_unlock(&pwent_mutex);
+                return ENOENT;
+        }
+        memcpy(pwd, pwtmp, sizeof(*pwd));
+        if (pwtmp->pw_name != NULL) {
+                pwd->pw_name = cursor;
+                cursor += strlcpy(cursor, pwtmp->pw_name, end - cursor) + 1;
+                if (cursor > end) {
+                        goto err_unlock;
+                }
+        }
+        if (pwtmp->pw_passwd != NULL) {
+                pwd->pw_passwd = cursor;
+                cursor += strlcpy(cursor, pwtmp->pw_passwd, end - cursor) + 1;
+                if (cursor > end) {
+                        goto err_unlock;
+                }
+        }
+        if (pwtmp->pw_gecos != NULL) {
+                pwd->pw_gecos = cursor;
+                cursor += strlcpy(cursor, pwtmp->pw_gecos, end - cursor) + 1;
+                if (cursor > end) {
+                        goto err_unlock;
+                }
+        }
+        if (pwtmp->pw_dir != NULL) {
+                pwd->pw_dir = cursor;
+                cursor += strlcpy(cursor, pwtmp->pw_dir, end - cursor) + 1;
+                if (cursor > end) {
+                        goto err_unlock;
+                }
+        }
+        if (pwtmp->pw_shell != NULL) {
+                pwd->pw_shell = cursor;
+                cursor += strlcpy(cursor, pwtmp->pw_shell, end - cursor) + 1;
+                if (cursor > end) {
+                        goto err_unlock;
+                }
+        }
+        pthread_mutex_unlock(&pwent_mutex);
+        *result = pwd;
+
+        return 0;
+err_unlock:
+        pthread_mutex_unlock(&pwent_mutex);
+        return ERANGE;
+}
+
+int fgetpwent_r(FILE *stream, struct passwd *pwd, char *buf, size_t len,
+                struct passwd **result)
+{
+        assert(stream != NULL);
+
+        return __fgetpwent_r(stream, pwd, buf, len, result);
+}
+
+#define ALIGN_PTR_TO_SIZE_OF(ptr, type)                                        \
+       ((type *) ((((uintptr_t)(ptr)) + sizeof(type) - 1)                     \
+                  & ~(sizeof(type) - 1)))
+
+static pthread_mutex_t grent_mutex = PTHREAD_MUTEX_INITIALIZER;
+
+static int __fgetgrent_r(FILE *stream, struct group *grp, char *buf, size_t len,
+                         struct group **result)
+{
+       struct group *grtmp;
+       char *cursor = buf, *end = buf + len;
+
+       *result = NULL;
+       pthread_mutex_lock(&grent_mutex);
+       grtmp = stream != NULL ? fgetgrent(stream) : getgrent();
+       if (grtmp == NULL) {
+               pthread_mutex_unlock(&grent_mutex);
+               return ENOENT;
+       }
+       memcpy(grp, grtmp, sizeof(*grp));
+       if (grtmp->gr_name != NULL) {
+               grp->gr_name = cursor;
+               cursor += strlcpy(cursor, grtmp->gr_name, end - cursor) + 1;
+               if (cursor > end) {
+                       goto err_unlock;
+               }
+       }
+       if (grtmp->gr_passwd != NULL) {
+               grp->gr_passwd = cursor;
+               cursor += strlcpy(cursor, grtmp->gr_passwd, end - cursor) + 1;
+               if (cursor > end) {
+                       goto err_unlock;
+               }
+       }
+       if (grtmp->gr_mem != NULL) {
+               char **members = ALIGN_PTR_TO_SIZE_OF(cursor, char *);
+               ptrdiff_t nameslen = 0;
+               size_t nmem = 0;
+
+               while (grtmp->gr_mem[nmem++] != NULL) {
+                       nameslen += strlen(grtmp->gr_mem[nmem - 1]) + 1;
+               }
+               nameslen += nmem * sizeof(*members);
+               if (nameslen > end - ((char *) members)) {
+                       goto err_unlock;
+               }
+
+               for (size_t i = 0; i < nmem; ++i) {
+                       members[i] = grtmp->gr_mem[i];
+               }
+
+               cursor = (char *) &members[nmem];
+               for (size_t i = 0; i < nmem - 1; ++i) {
+                       cursor = stpcpy(cursor, members[i]) + 1;
+               }
+       }
+       pthread_mutex_unlock(&grent_mutex);
+       *result = grp;
+
+       return 0;
+
+err_unlock:
+       pthread_mutex_unlock(&grent_mutex);
+       return ERANGE;
+}
+
+int fgetgrent_r(FILE *stream, struct group *grp, char *buf, size_t len,
+                struct group **result)
+{
+       assert(stream != NULL);
+
+       return __fgetgrent_r(stream, grp, buf, len, result);
+}
+
 static void uids_gids_range_err_log()
 {
     ERROR("uids and gids must be in range 0-%lld", MAXUID);

--- iSulad-v2.0.17/src/cmd/isulad/main.c        2022-10-14 14:04:50.303324243 +0800
+++ iSulad-v2.0.17/src/cmd/isulad/main.c        2022-10-14 14:06:08.262895032 +0800
@@ -40,6 +40,7 @@
 #include <string.h>
 #include <strings.h>
 #include <sys/time.h>
+#include <malloc_utils.h>
 #ifdef ENABLE_SUP_GROUPS
 #include <grp.h>
 #endif

--- iSulad-v2.0.17/src/daemon/modules/image/oci/storage/layer_store/layer_store.c       2022-10-18 08:58:45.194015191 +0000
+++ iSulad-v2.0.17/src/daemon/modules/image/oci/storage/layer_store/layer_store.c       2022-10-18 08:50:36.870156051 +0000
@@ -31,7 +31,7 @@
 #include <string.h>
 #include <sys/types.h>
 #include <sys/stat.h>
-#include <sys/unistd.h>
+#include <unistd.h>

 #include <archive.h>
 #include <archive_entry.h>
